# About
PGOnlineは、Webブラウザで動作するオンラインゲームである。
ゲーム内容は[スーパーマリオパーティ ジャンボリー](https://www.nintendo.com/jp/switch/a7hla/index.html)の「プクプクとゲッソー」というミニゲームのコピーである。

2名のユーザがWebクライアントを起動すると、ゲームが開始する。ユーザは左右の矢印キーで、バーを操作する。
ゲームの処理はサーバで行われ、Webクライアントはユーザ入力の送信と、ゲーム状態の受信・描画のみを行う。

Amazon Lightsailを用いて、[http://54.150.123.87:3000](http://54.150.123.87:3000)にデプロイしてある。このIPアドレスに接続すると、Webクライアントを起動できる。2つのWebクライアントが起動すると、ゲームが始まる。ただし、ゲームの読み込みが完了した後に、ブラウザを一度画面に表示しないと(フォアグラウンドプロセスにしないと)、ゲームが開始しない。

# Boot
本リポジトリをクローンしたら、次のコマンドで起動できる。

```
cd pgonline
docker compose up --build -d
```

コマンドを実行すると、ゲームサーバ(server)とWebクライアント用サーバ(client)のDockerコンテナが、それぞれローカルホストに立ち上がる。
ポート番号は、serverが8080、clientが3000にバインディングされる。

[http://localhost:3000](http://localhost:3000)を開くと、Webクライアントが起動する。

# Use case
<img src="readme_assets/PGOnline.png">
ユーザがゲームをプレイする時に起こることを、上図に記述している。
本システムは、Webクライアントとゲームサーバからなる。

1. ユーザがWebクライアント用サーバ[http://54.150.123.87:3000](http://54.150.123.87:3000) にHTTP通信でアクセスし、ブラウザでWebクライアントが動作する。
2. Webクライアントがゲームサーバ[ws://54.150.123.87:8080](ws://54.150.123.87:8080) にWebSocket通信でアクセスする。
3. ゲームサーバに2つのWebクライアントが同時にアクセスすると、ゲームサーバでゲームが開始する。ゲームの実行中、Webクライアントがゲームサーバにユーザの操作を送信し続ける。ゲームサーバはWebクライアントにゲームの状態(バーの傾きやボールの位置)を送信し続ける。

# Deployment
[Amazon Lightsail](https://lightsail.aws.amazon.com/)にデプロイしている。AWSのシンプルなレンタルサーバである。

# Project
## Overview
### Client
ユーザのブラウザで実行される、Webクライアントアプリケーションについて述べる。このアプリケーションはNext.jsによるSingle Page Application(SPA)である。Webクライアント上で、UnityによってWebGL向けにビルドしたアプリケーションが動作する。現時点では、Next.jsはUnityアプリケーションを動かすためだけに使用している。

Unityアプリケーションは、次の機能を担当する。
- ゲームサーバとのWebSocket通信
  - ユーザ入力の送信
  - ゲーム状態(バーの傾きやボールの位置)の受信
- 受信したデータからの、ゲーム画面の描画

WebSocket通信は、サーバとクライアントを接続し、双方向的に通信を行うものである。サーバからクライアントに積極的にデータを送信できるため、リアルタイム性が重要なゲームサーバに向く。

### Server
ゲームサーバについて述べる。

メインの処理は、以下を担当する。
- WebクライアントからのWebSocket接続を受け付け、そのクライアントをキューに追加する。
- キューに2名が追加されたら、それらをゲームの非同期タスクに渡し、キューから取り除く。

ゲームの非同期タスクは、以下の処理が並列して行われる。これらの処理は、共有メモリで情報をやり取りする。
- WebSocket通信でWebクライアントからユーザの入力を受け取り、共有メモリに書き込む。
- 共有メモリからゲームの状態(バーの傾きやボールの位置)を読み出し、WebSocket通信でWebクライアントに送る。
- ゲーム上のオブジェクトを更新し、ゲームの状態を共有メモリに書き込む。
  - バーの傾きは、共有メモリ上のユーザの入力によって更新する。
  - ボールの位置は、運動方程式に従って更新する。

## Directories and Files
プロジェクト構成について、重要なディレクトリ・ファイルをピックアップして説明する。

- client:   Next.js製のWebクライアントアプリケーション。
  - public
    - unity:    WebGL向けにビルドしたUnity製ゲームを格納する。
    - src/app
      - page.tsx:   メインのWebページを定義する。単にpublic/unityにあるゲームを読み込み、表示している。
- server:   RustのTauri-Tungstenite製のゲームサーバ。
  - src
    - main.rs:  サーバプログラムのエントリポイント。WebクライアントとWebSocket通信を行う。2つのWebクライアントから通信を受けると、ゲームの非同期タスクを開始する。ゲームの非同期タスクとやり取りし、Webクライアントの入出力を送受信する。
    - game:     ゲームの処理を行う、非同期タスクを定義する。
      - game.rs:    ゲームループを定義する。
      - bar.rs:     ゲーム中でプレイヤーが操作できる棒の挙動を定義する。
      - bubble.rs:  ゲーム中で転がってくる玉の挙動を定義する。
      - shared_memory.rs:   src/main.rsのタスクとsrc/gameのタスクがやり取りする情報を定義する。
- unity/PGClient:   Webクライアントで操作できるUnityゲームを開発するプロジェクト。WebGL向けにビルドしたものが、既にclient/public/unityに入っている。
  - Assets/Scripts: 書いたコード。
    - Connection.cs:    ゲームサーバとのWebSocket通信を確立し、ユーザの入力を送信し、ゲームの状態を受信する。
- protocol.md: WebSocket通信で送受信するバイナリについて、その作成ルールを説明する。